<!DOCTYPE html>
<html lang="ja">

<head>
	<link rel="stylesheet" href="jscss/main.css">
	<link rel="stylesheet" href="jscss/checkbox_tree.css">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<script src="./jscss/kuromoji.js"></script>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script type="text/javascript" src="./jscss/sparql.js" charset="UTF-8"></script>
	<script src="./jscss/dbpedia_category.js"></script>
	<script src="./jscss/categorylist_color.js"></script>
	<title>Wikidataによる文章アノテーションシステム</title>

	<script>
		//kuromoji必要変数
		const ids = [];
		const names = [];
		const DICT_PATH = "./dict";


		const keylink = "item";	//リンクのkeyとする変数
		const detail_html = "details.html"; //詳細表示用のHTMLファイル
		detailsType = "window";//詳細表示の表示先("window":別Window，"iframe":iframeで同一画面，"blank":別タブ)
		isShowQuery = true;//「クエリ表示」ボタンを表示するか？（サービス公開時はfalseにするとよい）
		var CSVLOG;//csv出力用のグローバル変数

		window.addEventListener('load', () => {
			const anotateButton = document.getElementById('anotate');
			//検索結果のカテゴリー表示エリア
			const resultArea0 = document.getElementById('result_category');
			//アノテーション後のテキスト表示エリア
			const resultArea1 = document.getElementById('result_div');
			//wikidata埋め込み用表示エリア
			const resultArea2 = document.getElementById('result_div_wiki');
			//カテゴリーチェックボックス階層
			const CATcheckbox = document.getElementsByClassName('hierarchy0');
			//例文の呼び出し
			//example1();

			//console.log("DBペディアカテゴリー", dbpedia_categorylist);
			//console.log("カテゴリー0階層目",CATcheckbox);

			anotateButton.addEventListener('click', () => {
				//アノテーションテキスト入出力
				var textINPUT = document.getElementById('input_text').value;
				var textOUTPUT = '';

				//ウィキデータ系の総合ログ
				var wikidata_log = new Array();
				//SPARQLQUERYの総合ログ
				var SPARQL_log = new Array();
				//フィルタリング後の形態素解析結果
				var words = new Array();
				//サーチAPIの結果取得上限数
				var APIlimit = document.getElementById('APIlimit').value;
				//リンクテキスト
				var linked_string = new Array();
				//API検索結果のカテゴリ一覧
				var searched_category = new Array();

				//詳細設定ラジオボタン
				const select_noun = radio_value('radio_noun');
				const searchtype = radio_value('labelType');

				// Loading 画像を表示
				dispLoading("処理中...");

				async function main() {
					//カテゴリーチェックボックス結果
					var checklist = new Map();
					var matchlist = new Map();
					for (let i = 0; i < CATcheckbox.length; i++) {
						//console.log(CATcheckbox[i]);
						if (CATcheckbox[i].checked) {
							checklist.set(CATcheckbox[i].id, CATcheckbox[i].value);

							let j = 0;
							while (true) {
								let CATcheckbox1 = document.getElementById('cat-' + i + '-' + j);
								if (CATcheckbox1 != null) {
									if (CATcheckbox1.checked) {
										checklist.delete(CATcheckbox[i].id);
										checklist.set(CATcheckbox1.id, CATcheckbox1.value);
									}
									j++;
								} else {
									break;
								}
							}
						}
					}
					//console.log('カテゴリナンバー → カテゴリ名', checklist);
					for (let db of dbpedia_categorylist) {
						for (let val of checklist.values()) {
							if (db.clsLabel.value == val) {
								matchlist.set(val, db.o.value);
							}
						}
					}
					//.log('カテゴリ名 → wikidata_url', matchlist);


					//kuoromoji形態素解析結果の格納
					var tokens = await promise_analysis(textINPUT);

					tokens.forEach((token) => {// 解析結果を順番に取得する
						if (select_noun == "u_noun") {
							if (token.pos_detail_1 == "固有名詞") {
								//固有名詞を抽出
								words.push(token);
							}
						} else {
							if (token.pos == "名詞") {
								//名詞を抽出
								words.push(token);
							}
						}
					});
					//単語の出現順にソート
					words.sort(function (a, b) {
						return a.word_position - b.word_position;
					});


					//ブラックリストかホワイトリストを使用するか判定
					if (select_noun == 'noun_w' || select_noun == 'noun_b') {
						const nounvalue = document.getElementById(select_noun).value;
						const nounlist = nounvalue.split(',');

						if (select_noun == 'noun_w') {
							words = match_whitelist(nounlist, words);
						} else if (select_noun == 'noun_b') {
							words = match_blacklist(nounlist, words);
						}
					}
					words = NGword(words);
					//単語の出現順にソート
					words.sort(function (a, b) {
						return a.word_position - b.word_position;
					});
					console.log("wikidata検索ワード", words);


					//複合語の取り出して検索
					let fukugougo = associated_noun(words);
					console.log("複合語", fukugougo);
					if (fukugougo.length != 0) {
						var fukugou_APIres = new Array();

						for (let i = 0; i < fukugougo.length; i++) {
							let search_word = fukugougo[i].map(obj => obj.name);
							let search_word_str = search_word.join('');

							if (searchtype == "Full") {
								if (2 < fukugougo[i].length) {
									//三単語以上の複合語をAPIで検索

									let res0 = await promise_get_action_wbsearchentities(search_word_str, APIlimit);
									let tmpres = new Array();
									for (let j = 0; j < res0.search.length; j++) {
										if (res0.search[j].match.text == search_word_str) {
											tmpres.push(res0.search[j]);
										}
									}
									if (tmpres.length != 0) {
										res0.search = tmpres;
									}
									//console.log(res0.searchinfo.search, res0);
									if (res0.search.length != 0) {
										fukugou_APIres.push({ 'name': res0.searchinfo.search, 'word_position': fukugougo[i][0].word_position, 'word_count': fukugougo[i].length, 'search': res0.search });
									} else if (res0.search.length == 0) {	//検索結果が見つからなかった場合分割して検索

										//まずは後ろを塊にして検索
										let res1 = await full_three_words_or_more_behind(search_word, APIlimit);
										if (res1 == 0) {

											//今度は前を塊にして検索
											let res2 = await full_three_words_or_more_forward(search_word, APIlimit);
											if (res2 == 0) {
												//0が返ってきた場合複合語での検索結果は見つかっていない
												console.log(search_word_str, "は検索結果無");
											} else if (res2 != 0) {
												if (res2.search.length != 0) {
													fukugou_APIres.push({ 'name': res2.searchinfo.search, 'word_position': fukugougo[i][0].word_position, 'word_count': res2.word_count, 'search': res2.search });
												}
											}

										} else if (res1 != 0) {
											if (res1.search.length != 0) {
												let word_position;
												for (let j = 0; j < fukugougo[i].length; j++) {
													if (res1.searchinfo.search.indexOf(fukugougo[i][j].name) == 0) {
														word_position = fukugougo[i][j].word_position;
													}
												}

												fukugou_APIres.push({ 'name': res1.searchinfo.search, 'word_position': word_position, 'word_count': res1.word_count, 'search': res1.search });
											}
										}
									}
								} else {
									//二単語の複合語の検索

									let res = await promise_get_action_wbsearchentities(search_word_str, APIlimit);
									let tmpres = new Array();
									for (let j = 0; j < res.search.length; j++) {
										if (res.search[j].match.text == search_word_str) {
											tmpres.push(res.search[j]);
										}
									}
									if (tmpres.length != 0) {
										fukugou_APIres.push({ 'name': res.searchinfo.search, 'word_position': fukugougo[i][0].word_position, 'word_count': fukugougo[i].length, 'search': tmpres });
									}
								}
							} else if (searchtype == "forward") {
								if (2 < fukugougo[i].length) {
									//三単語以上の複合語をAPIで検索

									let res0 = await promise_get_action_wbsearchentities(search_word_str, APIlimit);
									res0.word_count = search_word.length;
									console.log(res0.searchinfo.search, res0);

									if (res0.search.length != 0) {
										fukugou_APIres.push({ 'name': res0.searchinfo.search, 'word_position': fukugougo[i][0].word_position, 'word_count': fukugougo[i].length, 'search': res0.search });

									} else if (res0.search.length == 0) { //検索結果が見つからなかった場合分割して検索

										//まずは後ろを塊にして検索
										let res1 = await forward_three_words_or_more_behind(search_word, APIlimit);
										if (res1 == 0) {

											//今度は前を塊にして検索
											let res2 = await forward_three_words_or_more_forward(search_word, APIlimit);
											if (res2 == 0) {
												//0が返ってきた場合複合語での検索結果は見つかっていない
												console.log(search_word_str, "は検索結果無");
											} else if (res2 != 0) {
												if (res2.search.length != 0) {
													fukugou_APIres.push({ 'name': res2.searchinfo.search, 'word_position': fukugougo[i][0].word_position, 'word_count': res2.word_count, 'search': res2.search });
												}
											}

										} else if (res1 != 0) {
											if (res1.search.length != 0) {
												let word_position;
												for (let j = 0; j < fukugougo[i].length; j++) {
													if (res1.searchinfo.search.indexOf(fukugougo[i][j].name) == 0) {
														word_position = fukugougo[i][j].word_position;
													}
												}

												fukugou_APIres.push({ 'name': res1.searchinfo.search, 'word_position': word_position, 'word_count': res1.word_count, 'search': res1.search });
											}
										}
									}

								} else {
									//二単語の複合語の検索

									let res = await promise_get_action_wbsearchentities(search_word_str, APIlimit);
									if (res.search.length != 0) {
										fukugou_APIres.push({ 'name': res.searchinfo.search, 'word_position': fukugougo[i][0].word_position, 'word_count': fukugougo[i].length, 'search': res.search });
									}
								}

							} else if (searchtype == "ambi") {
								if (2 < fukugougo[i].length) {
									//三単語以上の複合語をAPIで検索

									let res0 = await promise_get_list_search(search_word_str, APIlimit);
									res0.word_count = search_word.length;
									console.log(search_word_str, res0);

									if (res0.query.search.length != 0) {
										fukugou_APIres.push({ 'name': search_word_str, 'word_position': fukugougo[i][0].word_position, 'word_count': fukugougo[i].length, 'search': res0.query.search });

									} else if (res0.query.search.length == 0) { //検索結果が見つからなかった場合分割して検索

										//まずは後ろを塊にして検索
										let res1 = await ambi_three_words_or_more_behind(search_word, APIlimit);
										if (res1 == 0) {

											//今度は前を塊にして検索
											let res2 = await ambi_three_words_or_more_forward(search_word, APIlimit);
											if (res2 == 0) {
												//0が返ってきた場合複合語での検索結果は見つかっていない
												console.log(search_word_str, "は検索結果無");
											} else if (res2 != 0) {
												if (res2.query.search.length != 0) {
													fukugou_APIres.push({ 'name': search_word_str, 'word_position': fukugougo[i][0].word_position, 'word_count': res2.word_count, 'search': res2.query.search });
												}
											}

										} else if (res1 != 0) {
											if (res1.query.search.length != 0) {
												const num = search_word.length - res1.word_count;
												const word_position = fukugougo[i][num].word_position;

												fukugou_APIres.push({ 'name': search_word_str, 'word_position': word_position, 'word_count': res1.word_count, 'search': res1.query.search });
											}
										}
									}

								} else {
									//二単語の複合語の検索

									let res = await promise_get_list_search(search_word_str, APIlimit);
									//console.log(res);
									if (res.query.search.length != 0) {
										fukugou_APIres.push({ 'name': search_word_str, 'word_position': fukugougo[i][0].word_position, 'word_count': fukugougo[i].length, 'search': res.query.search });
									}
								}
							}
						}
						console.log("複合語検索結果", fukugou_APIres);

						var fukugou_linked_string = new Array();
						if (searchtype == 'ambi') {
							for (let i = 0; i < fukugou_APIres.length; i++) {
								console.log(fukugou_APIres[i]);
								let wikidata_ids = '';
								let name = fukugou_APIres[i].name;
								let info = fukugou_APIres[i].search;

								let sparlqres = await create_linked_string_ambi(name, info, fukugou_APIres[i].word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log);
								sparlqres.word_count = fukugou_APIres[i].word_count;
								fukugou_linked_string.push(sparlqres);

							}

						} else {
							for (let i = 0; i < fukugou_APIres.length; i++) {
								let wikidata_ids = '';
								let name = fukugou_APIres[i].name;
								let info = fukugou_APIres[i].search;

								let sparlqres = await create_linked_string_forward(name, info, fukugou_APIres[i].word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log);
								sparlqres.word_count = fukugou_APIres[i].word_count;
								fukugou_linked_string.push(sparlqres);

							}
						}
						//console.log(fukugou_linked_string);

					}

					var linked_string = new Array();
					for (let i = 0; i < words.length; i++) {
						let judge = fukugou_linked_string.some((data) => data.word_position == words[i].word_position);
						if (judge === true) {
							let index = fukugou_linked_string.findIndex(({ word_position }) => word_position == words[i].word_position);
							i += (fukugou_linked_string[index].word_count - 1);

						} else {
							//検索対象のwikidataid
							let wikidata_ids = '';

							if (searchtype == "Full") {

								//前方一致でAPIでwikidataに問い合わせ
								let APIresponse = await promise_get_action_wbsearchentities(words[i].surface_form, APIlimit);
								//console.log("サーチAPI結果(前方一致)", APIresponse);
								let name = APIresponse.searchinfo.search;
								let info = new Array();
								for (let j = 0; j < APIresponse.search.length; j++) {
									if (APIresponse.search[j].match.text == words[i].surface_form) {
										info.push(APIresponse.search[j]);
									}
								}
								if (info.length != 0) {
									let sparlqres = await create_linked_string_forward(name, info, words[i].word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log);
									linked_string.push(sparlqres);
								}


							} else if (searchtype == "forward") {

								//前方一致でAPIでwikidataに問い合わせ
								let APIresponse = await promise_get_action_wbsearchentities(words[i].surface_form, APIlimit);
								if (APIresponse.search.length != 0) {
									console.log("サーチAPI結果(前方一致)", APIresponse);
									let name = APIresponse.searchinfo.search;
									let info = APIresponse.search;

									let sparlqres = await create_linked_string_forward(name, info, words[i].word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log);
									linked_string.push(sparlqres);
								}

							} else if (searchtype == "ambi") {
								//あいまいでAPIでwikidataに問い合わせ
								let APIresponse = await promise_get_list_search(words[i].surface_form, APIlimit)
								//console.log("サーチAPI結果(あいまい)対象:" + words[i].surface_form, APIresponse.query);
								if (APIresponse.query.search.length != 0) {
									let name = words[i].surface_form;
									let info = APIresponse.query.search;

									let sparlqres = await create_linked_string_ambi(name, info, words[i].word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log);
									linked_string.push(sparlqres);
								}

							}
						}
					}
					console.log('wikidata検索結果', wikidata_log);
					console.log('SPARQL検索結果', SPARQL_log);

					var LOG = new Array();
					for (let i = 0; i < tokens.length; i++) {
						const judge0 = fukugou_linked_string.some((data) => data.word_position == tokens[i].word_position);
						const judge = linked_string.some((data) => data.word_position == tokens[i].word_position);
						//console.log(judge0);
						if (judge0 === true) {
							for (let j = 0; j < fukugou_linked_string.length; j++) {
								if (fukugou_linked_string[j].word_position == tokens[i].word_position) {
									textOUTPUT += fukugou_linked_string[j].link;
									LOG.push(fukugou_linked_string[j]);
									//console.log(fukugou_linked_string[j].link);
									i += (fukugou_linked_string[j].word_count - 1);
									break;
								}
							}
						} else if (judge === true) {
							//console.log(tokens[i].surface_form)
							for (let j = 0; j < linked_string.length; j++) {
								if ((linked_string[j].word_position == tokens[i].word_position) && (linked_string[j].name == tokens[i].surface_form)) {
									textOUTPUT += linked_string[j].link;
									LOG.push(linked_string[j]);
									break;
								}
							}
						} else if (judge == false) {
							textOUTPUT += tokens[i].surface_form;
						}
					}

					//単語の出現順にソート
					LOG.sort(function (a, b) {
						return a.word_position - b.word_position;
					});
					console.log('置き換えられた単語', LOG);
					CSVLOG = LOG;

					// Loading 画像を消す
					removeLoading();
					resultArea0.innerHTML = '<H2>カテゴリー</H2>' + searched_category;
					resultArea1.innerHTML = '<H2>アノテーション結果</H2>' + textOUTPUT;
					//document.getElementById('download').style.display = 'inline'
					//resultArea2.innerHTML = '<iframe id="kg" name="kg" width=450" height="600" ></iframe>';
					return resultArea1;
				}
				main();

			}, false);
		}, false);

		//カテゴリーチェック関数()

		//kuromoji形態素解析(解析文章)
		function promise_analysis(text) {
			return new Promise((resolve) => {
				// Kuromoji
				kuromoji.builder({ dicPath: DICT_PATH }).build((err, tokenizer) => {
					const tokens = tokenizer.tokenize(text);// 解析データの取得
					console.log("形態素解析結果", tokens);

					//console.log(words);
					return resolve(tokens);
				});
			});
		}

		//mediawiki_API 前方一致(検索ワード,結果取得上限数)
		function promise_get_action_wbsearchentities(word, limit) {
			return new Promise((resolve) => {

				let urlw = "https://www.wikidata.org/w/api.php?action=wbsearchentities&search=" + word + "&limit=" + limit + "&language=ja&format=json&origin=*";
				fetch(urlw)
					.then(function (response) { return resolve(response.json()); })
					.catch(function (error) { console.log(error); });
			})
		}

		//wikibase_API あいまい(検索ワード,結果取得上限数)
		function promise_get_list_search(word, limit) {
			return new Promise((resolve) => {
				let urlw = "https://www.wikidata.org/w/api.php?action=query&list=search&srsearch=" + word + "&srlimit=" + limit + "&sroffset=0&format=json&origin=*";
				fetch(urlw)
					.then(function (response) { return resolve(response.json()); })
					.catch(function (error) { console.log(error); });
			})
		}

		//カテゴリー選択関数
		function select_category(query_data, checklist, matchlist,) {
			let purpose_id = new Array();
			let color = new Array();

			for (let q of query_data) {
				//console.log(q);
				let idx1 = Array.from(matchlist.values()).indexOf(q.o.value);

				if (idx1 != -1) {
					//console.log('選択されたカテゴリー',Array.from(matchlist.values()));
					//console.log('カテゴリーにマッチしたID', q);
					//console.log(idx1);

					purpose_id.push(q);
					let idx2 = Array.from(checklist.values()).indexOf(Array.from(matchlist.entries())[idx1][0]);
					reg = new RegExp("cat-\d(-\d)+", "g");

					if (idx2 != -1) {
						//console.log(Array.from(checklist.values()));
						//console.log(Array.from(matchlist.entries())[idx1][0]);
						//console.log(idx2);

						let tmp;
						if (reg.test(Array.from(checklist.entries())[idx2][0])) {
							let tmp1 = Array.from(checklist.entries())[idx2][0].slice(5);
							tmp = Array.from(checklist.entries())[idx2][0].replace(tmp1, "");
						} else {
							tmp = Array.from(checklist.entries())[idx2][0];
						}
						let idx3 = Object.keys(category_color).indexOf(tmp);
						color.push(category_color['cat-' + idx3]);

						//console.log(Array.from(checklist.entries())[idx2][0]);
						//console.log(idx3);
						//console.log(category_color);
						//console.log(category_color['cat-' + idx3]);
					}
				}
			}
			//console.log(purpose_id);
			//console.log(color);
			let res = [purpose_id[0], color[0]];

			return res;
		}

		//wikidata sparql endpoint(wikidataID:Q???)
		function sparql_query(ids) {
			return new Promise((resolve) => {
				//SPARQLエンドポイントの初期設定
				var endpoint = "https://query.wikidata.org/sparql";

				//SPARQLクエリの発行
				//idsにsearchAPIで返ってきた「Q???」を全て代入
				var query = 'PREFIX wdt: <http://www.wikidata.org/prop/direct/> \n'
					+ 'PREFIX wd: <http://www.wikidata.org/entity/> \n'
					+ 'select  DISTINCT ?s ?sLabel ?o ?oLabel \n'
					+ 'where{ \n'
					+ 'VALUES ?s {' + ids + '} \n'
					+ '?s wdt:P31/wdt:P279* ?o.  \n'
					+ 'SERVICE wikibase:label { bd:serviceParam wikibase:language "ja,en". }\n'
					+ '}'
				//console.log(query)

				//SPARQLクエリの実行（sparql.jsで定義している関数を利用）
				qr = sendQuery(endpoint, query);

				qr.fail(//クエリが失敗したときの処理
					function (xhr, textStatus, thrownError) {
						//alert("Error: A '" + textStatus + "' occurred.");
					}
				);
				qr.done(//クエリが成功したときの処理
					function (d) {
						//console.log(d);
						return resolve(d.results.bindings);
					}
				);
			})

		}

		//検索結果カテゴリー作成用関数(サーチ後のカテゴリ一覧,sparqlqerydata)
		function create_category(category, data) {
			//下のコードでサーチ後のカテゴリー作成
			let OLABEL = new Array();
			for (let j = 0; j < data.length; j++) {
				OLABEL.push(data[j].oLabel.value);
				if (category.indexOf(data[j].oLabel.value) == -1) {
					category.push(data[j].oLabel.value);
				}
			}
			return OLABEL;
		}


		//ブラックリストの照会をして、削除したものを返す(ブラックリスト,形態素解析結果（名詞）)
		function match_blacklist(blacklist, target) {
			let list = new Array();
			for (let i = 0; i < target.length; i++) {
				let pos1 = blacklist.some((word) => word == target[i].pos_detail_1);
				let pos2 = blacklist.some((word) => word == target[i].pos_detail_2);
				let pos3 = blacklist.some((word) => word == target[i].pos_detail_3);

				if ((pos1 || pos2 || pos3) == false) {
					list.push(target[i]);
				}
			}
			return list;
		}

		//ホワイトリストの照会をして、削除したものを返す(ホワイトリスト,形態素解析結果（名詞）)
		function match_whitelist(whitelist, target) {
			let list = new Array();
			for (let i = 0; i < whitelist.length; i++) {
				for (let j = 0; j < target.length; j++) {
					if (whitelist[i] === target[j].pos_detail_1) {
						list.push(target[j]);
					} else if (whitelist[i] === target[j].pos_detail_2) {
						list.push(target[j]);
					} else if (whitelist[i] === target[j].pos_detail_3) {
						list.push(target[j]);
					}
				}
			}
			return list;
		}

		//NG検索ワードの排除
		function NGword(target) {
			let list = new Array();
			const ngword = document.getElementById('NGtext').value.split(',');
			for (let i = 0; i < target.length; i++) {
				let flag = ngword.some((word) => word == target[i].surface_form);
				if (flag == false) {
					list.push(target[i]);
				}
			}
			return list;
		}

		//複合語の取り出し
		function associated_noun(words) {
			let position;
			let associated_nouns = new Array();
			let j = 0;

			for (let i = 0; i < words.length; i++) {
				let tmparray = new Array();
				let dct = { "name": words[i].surface_form, "word_position": words[i].word_position };
				tmparray.push(dct);

				position = words[i].word_position + words[i].surface_form.length;
				//console.log("一番目の単語位置", words[i].word_position, "次の単語位置(予測)", position);

				j = i + 1;
				//console.log(i, j);

				let k = 0;
				while ((j < words.length) && (position == words[j].word_position)) {
					//console.log("次の単語位置", words[j].word_position);
					dct = { "name": words[j].surface_form, "word_position": words[j].word_position };
					tmparray.push(dct);
					position += words[j].surface_form.length;
					k++;
					j++;
				}
				i += k;
				if (1 < tmparray.length) {
					associated_nouns.push(tmparray);
					//console.log(tmparray);
				}

			}
			//console.log("複合語(名詞と名詞)", associated_nouns);
			return associated_nouns;
		}

		//(完全一致)三つ以上の複合語の後方検索処理(複合語リスト,APIlimit)
		async function full_three_words_or_more_behind(words, limit) {
			let len = words.length;
			if (len - 1 > 1) {
				let tmpwords = new Array();
				for (let i = 1; i < len; i++) {
					tmpwords.push(words[i]);
				}
				let words_str = tmpwords.join('');
				let res1 = await promise_get_action_wbsearchentities(words_str, limit);
				res1.word_count = tmpwords.length;
				let tmpres = new Array();
				for (let i = 0; i < res1.search.length; i++) {
					if (res1.search[i].match.text == words_str) {
						tmpres.push(res1.search[i]);
					}
				}
				if (tmpres.length != 0) {
					res1.search = tmpres;
				}

				//console.log(words_str, res1)
				if (res1.search.length == 0) {
					let res2 = await forward_three_words_or_more_behind(tmpwords, limit);
					if (res2 != 0) {
						return res2;
					} else {
						return 0;
					}
				} else if (res1.search.length != 0) {
					return res1
				}

			} else {
				return 0;
			}
		}
		//(完全一致)三つ以上の複合語の前方検索処理(複合語リスト,APIlimit)
		async function full_three_words_or_more_forward(words, limit) {
			let len = words.length;
			if (len - 1 > 1) {
				let tmpwords = new Array();
				for (let i = 0; i < len - 1; i++) {
					tmpwords.push(words[i]);
				}
				let words_str = tmpwords.join('');
				let res1 = await promise_get_action_wbsearchentities(words_str, limit);
				res1.word_count = tmpwords.length;
				let tmpres = new Array();
				for (let i = 0; i < res1.search.length; i++) {
					if (res1.search[i].match.text == words_str) {
						tmpres.push(res1.search[i]);
					}
				}
				//console.log('完全一致', tmpres)
				if (tmpres.length != 0) {
					res1.search = tmpres;
				}

				//console.log(words_str, res1)
				if (res1.search.length == 0) {
					let res2 = await forward_three_words_or_more_forward(tmpwords, limit);
					if (res2 != 0) {
						return res2;
					} else {
						return 0;
					}
				} else if (res1.search.length != 0) {
					return res1;
				}

			} else {
				return 0;
			}
		}

		//(前方一致)三つ以上の複合語の後方検索処理(複合語リスト,APIlimit)
		async function forward_three_words_or_more_behind(words, limit) {
			let len = words.length;
			if (len - 1 > 1) {
				let tmpwords = new Array();
				for (let i = 1; i < len; i++) {
					tmpwords.push(words[i]);
				}
				let words_str = tmpwords.join('');
				let res1 = await promise_get_action_wbsearchentities(words_str, limit);
				res1.word_count = tmpwords.length;
				console.log(words_str, res1)
				if (res1.search.length == 0) {
					let res2 = await forward_three_words_or_more_behind(tmpwords, limit);
					if (res2 != 0) {
						return res2;
					} else {
						return 0;
					}
				} else if (res1.search.length != 0) {
					return res1;
				}

			} else {
				return 0;
			}
		}
		//(前方一致)三つ以上の複合語の前方検索処理(複合語リスト,APIlimit)
		async function forward_three_words_or_more_forward(words, limit) {
			let len = words.length;
			if (len - 1 > 1) {
				let tmpwords = new Array();
				for (let i = 0; i < len - 1; i++) {
					tmpwords.push(words[i]);
				}
				let words_str = tmpwords.join('');
				let res1 = await promise_get_action_wbsearchentities(words_str, limit);
				res1.word_count = tmpwords.length;
				console.log(words_str, res1)
				if (res1.search.length == 0) {
					let res2 = await forward_three_words_or_more_forward(tmpwords, limit);
					if (res2 != 0) {
						return res2;
					} else {
						return 0;
					}
				} else if (res1.search.length != 0) {
					return res1;
				}

			} else {
				return 0;
			}
		}

		//(あいまい)三つ以上の複合語の後方検索処理(複合語リスト,APIlimit)
		async function ambi_three_words_or_more_behind(words, limit) {
			let len = words.length;
			if (len - 1 > 1) {
				let tmpwords = new Array();
				for (let i = 1; i < len; i++) {
					tmpwords.push(words[i]);
				}
				let words_str = tmpwords.join('');
				let res1 = await promise_get_list_search(words_str, limit);
				res1.word_count = tmpwords.length;
				console.log(words_str, res1)
				if (res1.query.search.length == 0) {
					let res2 = await ambi_three_words_or_more_behind(tmpwords, limit);
					if (res2 != 0) {
						return res2;
					} else {
						return 0;
					}
				} else if (res1.query.search.length != 0) {
					return res1;
				}

			} else {
				return 0;
			}
		}
		//(あいまい)三つ以上の複合語の前方検索処理(複合語リスト,APIlimit)
		async function ambi_three_words_or_more_forward(words, limit) {
			let len = words.length;
			if (len - 1 > 1) {
				let tmpwords = new Array();
				for (let i = 0; i < len - 1; i++) {
					tmpwords.push(words[i]);
				}
				let words_str = tmpwords.join('');
				let res1 = await promise_get_list_search(words_str, limit);
				res1.word_count = tmpwords.length;
				console.log(words_str, res1)
				if (res1.query.search.length == 0) {
					let res2 = await ambi_three_words_or_more_forward(tmpwords, limit);
					if (res2 != 0) {
						return res2;
					} else {
						return 0;
					}
				} else if (res1.query.search.length != 0) {
					return res1;
				}

			} else {
				return 0;
			}
		}

		//カテゴリーのマッチメイキング、リンクテキストの生成(検索単語, APIres.search, 単語の位置, checklist, matchlist, 結果格納配列,ログ格納用配列)
		async function create_linked_string_forward(name, info, word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log) {

			//ログを蓄積
			wikidata_log.push({ 'name': name, 'info': info });

			//APIの結果を整形し、SPARQLで問い合わせ
			if (info.length !== 0) {
				if (Array.from(checklist.entries()).length != 0) {

					let wikidata_ids = '';
					//sparqlqeryの生成、問い合わせ
					for (let j = 0; j < info.length; j++) {
						wikidata_ids += "wd:" + info[j].id + " ";
					}
					let query_data = await sparql_query(wikidata_ids);
					//console.log("クエリの結果", query_data);
					SPARQL_log.push({ 'name': name, 'SPARQL': query_data });
					//console.log(Array.from(checklist.entries()).length);

					//カテゴリーにマッチしたwikidataidと色の対応
					let s_cat = select_category(query_data, checklist, matchlist);
					//console.log(Array.isArray(s_cat[0]));
					if (s_cat[0] !== undefined) {
						wikidata_log.pop();
						wikidata_log.push({ 'name': name, 'info': info, 'category': create_category(searched_category, query_data) });
						//リンクテキストの生成
						return ({
							'name': name, 'word_position': word_position, 'wikidata_id': s_cat[0].s.value.replace("http://www.wikidata.org/entity/", ""), 'wikidataURL': s_cat[0].s.value
							, 'link': '<b><a href="javascript:ShowDetails(' + "'https://kgs.hozo.jp/sample/details.html?key=wd:"
								+ s_cat[0].s.value.replace("http://www.wikidata.org/entity/", "")
								+ "'" + ');" style ="background:' + s_cat[1] + '">' + name + '</a></b>'
						});
					} else {
						return ({
							'name': name, 'word_position': word_position, 'wikidata_id': info[0].title, 'wikidataURL': info[0].concepturi
							, 'link': '<b><a href="javascript:ShowDetails(' + "'https://kgs.hozo.jp/sample/details.html?key=wd:"
								+ info[0].title + "');" + '">' + name + '</a></b>'

						});
					}

				} else {
					return ({
						'name': name, 'word_position': word_position, 'wikidata_id': info[0].title, 'wikidataURL': info[0].concepturi
						, 'link': '<b><a href="javascript:ShowDetails(' + "'https://kgs.hozo.jp/sample/details.html?key=wd:"
							+ info[0].id + "');" + '">' + name + '</a></b>'
					});
				}

			}
		}


		async function create_linked_string_ambi(name, info, word_position, checklist, matchlist, searched_category, wikidata_log, SPARQL_log) {

			//ログを蓄積
			wikidata_log.push({ 'name': name, 'info': info });

			//APIの結果を整形し、SPARQLで問い合わせ
			if (info.length !== 0) {
				if (Array.from(checklist.entries()).length != 0) {
					let wikidata_ids = '';
					//sparqlqeryの生成、問い合わせ
					for (let j = 0; j < info.length; j++) {
						wikidata_ids += "wd:" + info[j].title + " ";
					}
					query_data = await sparql_query(wikidata_ids);
					//console.log("クエリの結果", query_data);
					SPARQL_log.push({ 'name': name, 'SPARQL': query_data });
					//カテゴリーにマッチしたwikidataidと色の対応
					let s_cat = select_category(query_data, checklist, matchlist);
					//console.log(Array.isArray(s_cat[0]));
					if (s_cat[0] !== undefined) {
						wikidata_log.pop();
						wikidata_log.push({ 'name': name, 'info': info, 'category': create_category(searched_category, query_data) });
						//リンクテキストの生成
						return ({
							'name': name, 'word_position': word_position, 'wikidta_id': s_cat[0].s.value.replace("http://www.wikidata.org/entity/", ""), 'wikidataURL': s_cat[0].s.value
							, 'link': '<b><a href="javascript:ShowDetails('
								+ "'https://kgs.hozo.jp/sample/details.html?key=wd:" + s_cat[0].s.value.replace("http://www.wikidata.org/entity/", "") + "'" + ');"'
								+ 'style ="background:' + s_cat[1] + '">' + name + '</a></b>'
						});
					} else {
						return ({
							'name': name, 'word_position': word_position, 'wikidata_id': info[0].title, 'wikidataURL': 'http://www.wikidata.org/entity/' + info[0].title
							, 'link': '<b><a href="javascript:ShowDetails(' + "'https://kgs.hozo.jp/sample/details.html?key=wd:"
								+ info[0].title + "');" + '">' + name + '</a></b>'
						});
					}
				} else {
					return ({
						'name': name, 'word_position': word_position, 'wikidata_id': info[0].title, 'wikidataURL': 'http://www.wikidata.org/entity/' + info[0].title
						, 'link': '<b><a href="javascript:ShowDetails(' + "'https://kgs.hozo.jp/sample/details.html?key=wd:"
							+ info[0].title + "');" + '">' + name + '</a></b>'
					});
				}
			}
		}

		//詳細設定のラジオボタン値取得(ラジオボタン名)
		function radio_value(name) {
			let elements = document.getElementsByName(name);
			let len = elements.length;
			let checkValue = '';

			for (let i = 0; i < len; i++) {
				if (elements.item(i).checked) {
					checkValue = elements.item(i).value;
					return checkValue;
				}
			}
		}

		//整形し、結果画面の文章を出力(形態素解析結果,リンクテキスト)
		function resultOUTPUT(tokens, linked_string) {
			let j = 0;
			let output = '';
			for (let i = 0; i < tokens.length; i++) {
				if (tokens[i].surface_form == linked_string[j][0]) {
					output += linked_string[j][1];
					if (j < linked_string.length) {
						j++;
					}
					continue;
				} else if (tokens.surface_form != linked_string[j][0]) {
					output += tokens[i].surface_form;
				}
			}
			return output;
		}

		//別ウィンドウwikidata表示関数
		function ShowDetails(page) {
			let lw = window.innerWidth - 400;
			let y = window.screenY + 100;

			if (lw < 0) { lw = 100; }
			window.open(page, "DetailsWin", "left=" + lw + ",top=" + y + ",width=400,height=600,scrollbars=1");
		}

		//csv関数
		function csvdownload(result) {
			var str = '';
			for (let i = 0; i < result.length; i++) {
				if (i == 0) {
					str += Object.keys(result[i]) + '\r\n';
				}
				str += Object.values(result[i]) + '\r\n';
			}

			var bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
			var blob = new Blob([bom, str], { type: "text/csv" }); //配列に上記の文字列(str)を設定
			var link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = result[0].name + '_' + times() + ".csv";
			link.click();
		}

		//時間呼び出し
		function times() {
			var now = new Date();

			var Year = now.getFullYear();
			var Month = now.getMonth() + 1;
			var date = now.getDate();
			var Hour = now.getHours();
			var Min = now.getMinutes();
			var Sec = now.getSeconds();

			return (Month + "月" + date + "日" + Hour + "時" + Min + "分" + Sec + "秒");
		}

		//ローディング画面用の関数
		function dispLoading(msg) {
			// 引数なしの場合、メッセージは非表示。
			if (msg === undefined) msg = "";

			// 画面表示メッセージを埋め込み
			var innerMsg = "<div id='innerMsg'>" + msg + "</div>";

			// ローディング画像が非表示かどうかチェックし、非表示の場合のみ出力。
			if ($("#nowLoading").length == 0) {
				$("body").append("<div id='nowLoading'>" + innerMsg + "</div>");
			}
		}

		//表示ストップ用の関数
		function removeLoading() {
			$("#nowLoading").remove();
		}

		//例文
		function example1() {
			var textarea = document.getElementById('input_text');
			textarea.value = "オキシトシン（OXT）は、視床下部で産生される神経ペプチドです。OXT産生ニューロンは軸索を神経下垂体後葉、"
				+ "つまり下垂体後葉に投射し、ペプチドホルモンとして末梢的にOXTを血液循環に放出します。これらのニューロン"
				+ "はまた、いくつかの脳領域を神経支配し、そこで神経ペプチドとしてOXTを放出します。したがって、OXTは、子宮"
				+ "収縮や授乳などの末梢性機能だけでなく、社会的、攻撃的、恐怖、母性行動などの中枢性機能の調節にも関与して"
				+ "います。"
			//console.log(document.getElementById('input_text').value);
		}
		function example2() {
			var textarea = document.getElementById('input_text');
			textarea.value = "日本国（にほんこく、にっぽんこく、英: Japan）、または日本（にほん、にっぽん）は、東アジアに位置する民主制国家[1]。首都は東京都[注 3][2][3]。"
				+ "全長3500キロメートル以上にわたる国土は、主に日本列島[注 7]および千島列島・南西諸島・伊豆諸島・小笠原諸島などの弧状列島により構成され[3][4]、大部分が温帯に属するが、"
				+ "北部や島嶼部では亜寒帯や熱帯の地域がある[5][6]。地形は起伏に富み、火山地・丘陵を含む山地の面積は国土の約75 % を占め[6]、沿岸の平野部に人口が集中している。"
				+ "国内には行政区分として47の都道府県があり、日本人（大和民族・琉球民族・アイヌ民族[注 8]・外国系の人々）と外国人が居住し、日本語を通用する[2][3]。"
				+ "明治維新後の1889年（明治22年）に大日本帝国憲法を制定し立憲国家となる。太平洋戦争後の連合国による占領期の1947年（昭和22年）には現行の日本国憲法を施行し民主制へ移行。"
				+ "1952年（昭和27年）、サンフランシスコ平和条約により主権を回復した[3]。"
			//console.log(document.getElementById('input_text').value);
		}
		function example3() {
			var textarea = document.getElementById('input_text');
			textarea.value = "養殖業（ようしょくぎょう、英語: aquaculture）とは、生物を、その本体または副生成物を食品や工業製品などとして利用することを目的として、"
				+ "人工的に育てる産業である。金魚、錦鯉などを鑑賞・愛玩目的で育てることは「養魚」と称する場合が多い[1]。"
				+ "狭義及び通常は、水産業（養殖漁業）の一種で、魚介類や海藻などの水棲生物の人為的繁殖について使われる。広義には、生物全般を育てることを指すが、"
				+ "陸生植物に関しては栽培・農耕、哺乳類に関しては畜産、そのうち乳牛などは酪農、ニワトリに関しては養鶏、ブタは養豚という用語がある。"
			//console.log(document.getElementById('input_text').value);
		}


	</script>
</head>

<body>
	<h1>Wikidataを用いたアノテーションシステム</h1>
	<hr>
	<main>
		<h3>
			<a class="treeview" href="https://github.com/masapi61/Annotation-by-Wikidata" target="_blank">
				使い方(githubレポジトリ)
			</a>
		</h3>
		<div class="left-column0">
			<ul class="treeview">
				<b>カテゴリー</b>:<br>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-0" value="activity">
					<label for="cat-0" style="background:rgb(255, 143, 143)" #>活動</label>
					<ul>
						<li class="expandable"><input class="hierarchy1" type="checkbox" id="cat-0-0" value="game">
							<label for="cat-0-0" style="background:rgb(255, 143, 143)">ゲーム</label>
						</li>
						<li class="expandable"><input class="hierarchy1" type="checkbox" id="cat-0-1" value="sport">
							<label for="cat-0-1" style="background:rgb(255, 143, 143)">スポーツ</label>
						</li>
					</ul>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-1"
						value="class of anatomical entity"> <label for="cat-1"
						style="background:gainsboro">解剖学的構造</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-2" value="disease">
					<label for="cat-2" style="background:rgb(117, 214, 161)">疾患</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-3" value="drug"> <label
						for="cat-3" style="background:yellow">薬</label></li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-4" value="organisation">
					<label for="cat-4" style="background:rgb(204, 179, 255)">組織</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-5" value="person">
					<label for="cat-5" style="background:orange">人物</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-6" value="place">
					<label for="cat-6" style="background:peachpuff">場所</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-7" value="chemical substance">
					<label for="cat-7" style="background:aqua">化学物質</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-8"
						value="group or class of organisms">
					<label for="cat-8" style="background:lime">生物</label>
				</li>
				<li class="expandable"><input class="hierarchy0" type="checkbox" id="cat-9" value="work">
					<label for="cat-9" style="background:pink">仕事</label>
				</li>
			</ul>
		</div>

		<div class="left-column">
			<button id="example1" onclick="example1()">例文1</button>
			<button id="example2" onclick="example2()">例文2</button>
			<button id="example3" onclick="example3()">例文3</button>
			<details>
				<summary><b>詳細設定</b></summary>
				<div class="left-column">
					<p>
						<b>ラベルの検索設定</b>:<br>
						<label><input type="radio" id="LabelFull" name="labelType" value="Full" checked>完全一致</label><br>
						<label><input type="radio" id="LabelForward" name="labelType" value="forward">前方一致</label><br>
						<label><input type="radio" id="LabelAmbi" name="labelType" value="ambi">あいまい検索</label><br>
						<label>ラベル取得上限数 <input type="text" id="APIlimit" value="10" size="3"></label><br><br>

						<b>品詞の選択</b>:<br>
						<label>
							<input type="radio" name="radio_noun" value="u_noun">固有名詞のみ
						</label><br>
						<label>
							<input type="radio" name="radio_noun" value="noun">名詞のみ
						</label><br>
						<label>
							<input type="radio" name="radio_noun" value="noun_w" checked>名詞ホワイトリスト
						</label><br>
						<input type="text" id="noun_w" size="40" value="固有名詞,一般,サ変接続"><br>
						<label>
							<input type="radio" name="radio_noun" value="noun_b">名詞ブラックリスト</label><br>
						<input type="text" id="noun_b" size="40" value="数,代名詞,非自立,形容動詞語幹,副詞可能"><br><br>

						<b>NGワード</b><br>
						<input type="text" id="NGtext" size="40" value="[,],][,]、,:,(,),注"><br><br>
					</p>
				</div>

			</details>
			<textarea id="input_text"></textarea>
			<br>
			<button id="anotate">アノテーション実行</button><br>
			<div id="download" style="display:none">
				<input type="button" id="downloadbtn" value="ダウンロード" style="margin-top:8px;"
					onclick="csvdownload(CSVLOG)"><br>
			</div>
			<div style="display:none">
				<div id="result_category"></div>
			</div>
			<div id="result_div"></div>
		</div>

		<div class="left-column">
			<div id="result_div_wiki"></div>
		</div>
	</main>

</body>

</html>